include:
  - local: .gitlab/ci/validate.yml
  - local: .gitlab/ci/test.yml
  - local: .gitlab/ci/integration.yml
  - local: .gitlab/ci/release.yml
  - local: .gitlab/ci/document.yml
  - project: 'gitlab-org/quality/pipeline-common'
    file:
      - '/ci/danger-review.yml'

default:
  image: golang:$GO_VERSION-buster
  tags:
    - gitlab-org
  cache:
    key:
      prefix: $GO_VERSION
      files:
        - go.mod
        - go.sum
    paths:
      - .GOPATH/pkg/mod/
    policy: pull

variables:
  # default Go version
  GO_VERSION: "1.18"
  BUILDTAGS: "include_gcs,include_oss,continuous_profiler_stackdriver"
  CGO_ENABLED: "1"
  GOPATH: $CI_PROJECT_DIR/.GOPATH
  GOTESTSUM_VERSION: v1.8.1
  PG_PREV_VERSION: "12"
  PG_CURR_VERSION: "13"
  PG_NEXT_VERSION: "14"

stages:
  - validate
  - test
  - integration
  - release
  - document

.go-pg-version-matrix:
  parallel:
    matrix:
      - PG_VERSION: $PG_PREV_VERSION
        GO_VERSION: [ "1.18", "1.19", "1.20" ]
      - PG_VERSION: $PG_CURR_VERSION
        GO_VERSION: [ "1.18", "1.19", "1.20" ]
      - PG_VERSION: $PG_NEXT_VERSION
        GO_VERSION: [ "1.18", "1.19", "1.20" ]